module.exports=function(){function e(e){var t=s.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return{x:0>n?0:n>t.width?t.width:n,y:0>i?0:i>t.height?t.height:i}}function t(){var e=parseInt(s.style.width),t=parseInt(s.style.height);y.x<0&&(y.x=0,y.x2=y.w),y.y<0&&(y.y=0,y.y2=y.h),y.x2>e&&(y.x2=e,y.x=y.x2-y.w),y.y2>t&&(y.y2=t,y.y=y.y2-y.h),y.w=y.x2-y.x,y.h=y.y2-y.y,d.style.top=y.y+"px",d.style.left=y.x+"px",d.style.right=~~(e-y.x2)+"px",d.style.bottom=~~(t-y.y2)+"px",u.setAttribute("d","M 0 0 v"+t+"h"+e+"v"+-t+"H-0zM"+y.x+" "+y.y+"h"+y.w+"v"+y.h+"h-"+y.w+"V-"+y.h+"z"),x.up&&x.up(y)}function n(n){n=e(n),y.x=n.x-.5*y.w,y.y=n.y-.5*y.h,y.x2=n.x+.5*y.w,y.y2=n.y+.5*y.h,t()}function i(e){s&&this.destroy(),s=document.querySelector(e),s.className+=" imgc ".indexOf(" "+x.cn+" ")>-1?"":" imgc"}function o(e){document.addEventListener("mousemove",h),document.addEventListener("mouseup",c),n(e)}function c(e){document.removeEventListener("mouseup",c),document.removeEventListener("mousemove",h)}function h(e){n(e)}function m(n,i,o){function c(e){e.stopPropagation(),document.addEventListener("mouseup",m),document.addEventListener("mousemove",h)}function h(n){n.stopPropagation(),n=e(n),o(n),t()}function m(e){e.stopPropagation(),document.removeEventListener("mouseup",m),document.removeEventListener("mousemove",h)}var r=document.createElement("span");return r.className="imgc-handles-el-"+n+"-"+i,r.addEventListener("mousedown",c),r}function r(e,t,n){t&&e&&(n=n||{},Object.keys(f).forEach(function(e){x[f[e][0]]=n[e]||f[e][1]}),x.mcw>80&&(y.x2=y.w=x.mcw),x.mch>80&&(y.y2=y.h=x.mch),x.fs&&(x.mcw>80||x.mch>80)&&(y.x2=y.y2=y.w=y.h=x.mcw>x.mch?x.mcw:x.mch),i.call(this,e),w=new Image,w.addEventListener("load",function(e){this.create()}.bind(this)),w.src=t)}var s,d,u,a=!1,y={},x={},w=null,p={w:1,h:1},f={update_cb:["up",!1],create_cb:["cr",!1],destroy_cb:["de",!1],min_crop_width:["mcw",32],min_crop_height:["mch",32],max_width:["mw",500],max_height:["mh",500],fixed_size:["fs",!1]},v=[function(e){var t=y.x;v[7](e),x.fs?y.y+y.x-t<0?(y.x=t-y.y,y.y=0):y.y+=y.x-t:v[4](e)},function(e){var t=y.x2;v[5](e),x.fs?y.y-y.x2+t<0?(y.x2=t+y.y,y.y=0):y.y-=y.x2-t:v[4](e)},function(e){var t=y.x2;if(v[5](e),x.fs){var n=s.getBoundingClientRect();y.y2+y.x2-t>n.height?(y.x2=t+(n.height-y.y2),y.y2=n.height):y.y2+=y.x2-t}else v[6](e)},function(e){var t=y.x;if(v[7](e),x.fs){var n=s.getBoundingClientRect();y.y2+(t-y.x)>n.height?(y.x=t-(n.height-y.y2),y.y2=n.height):y.y2-=y.x-t}else v[6](e)},function(e){y.y=y.y2-e.y<x.mch?y.y2-x.mch:e.y},function(e){y.x2=e.x-y.x<x.mcw?y.x+x.mcw:e.x},function(e){y.y2=e.y-y.y<x.mch?y.y+x.mch:e.y},function(e){y.x=y.x2-e.x<x.mcw?y.x2-x.mcw:e.x}];return r.prototype.create=function(e){if(!a){s||i.call(this,e);var n=w.width,c=w.height;n>x.mw&&(c=~~(x.mw*c/n),n=x.mw),c>x.mh&&(n=~~(x.mh*n/c),c=x.mh),p={w:w.naturalWidth/n,h:w.naturalHeight/c},s.style.width=n+"px",s.style.height=c+"px",s.addEventListener("DOMNodeRemovedFromDocument",this.destroy),s.appendChild(w);var h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("height",c),h.setAttribute("width",n),s.appendChild(h),u=document.createElementNS("http://www.w3.org/2000/svg","path"),h.appendChild(u),d=document.createElement("div"),d.className="imgc-handles",s.appendChild(d);for(var r=0;r<(x.fs?4:8);r++)d.appendChild(new m(x.fs?0:~~(r/4),r%4,v[r]));s.addEventListener("mousedown",o),a=!0,y={x:0,y:0,x2:0,y2:0,w:0,h:0},n===c?y.x2=y.y2=n:n>c?(y.x2=c,y.y2=x.fs?c:c-(n-c)):c>n&&(y.x2=x.fs?n:n-(c-n),y.y2=n),t(),x.cr&&x.cr({w:n,h:c})}},r.prototype.destroy=function(){if(a){if(s){for(s.removeEventListener("DOMNodeRemovedFromDocument",this.destroy),s.removeEventListener("mousedown",o);s.firstChild;)s.removeChild(s.firstChild);s=w=d=u=null}a=!1,x.de&&x.de()}},r.prototype.crop=function(e,t){(!e||"image/jpeg"!==e&&"image/png"!==e)&&(e="image/jpeg"),(!t||0>t||t>1)&&(t=1);var n=document.createElement("canvas");n.setAttribute("width",y.w),n.setAttribute("height",y.h);var i=n.getContext("2d");return i.drawImage(w,p.w*y.x,p.h*y.y,p.w*y.w,p.h*y.h,0,0,y.w,y.h),n.toDataURL(e,t)},r}();